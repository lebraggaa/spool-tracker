<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rastreamento de S-B-O-O-L</title>

  <!-- Ícones (use o mesmo nome do arquivo que está no repo) -->
  <link rel="icon" href="icon.PNG?v=1">
  <link rel="apple-touch-icon" href="icon.PNG?v=1">

  <style>
    :root{
      --bg1:#0a1224;
      --bg2:#0e1c3a;
      --card:#0e1a33cc;
      --stroke:#2b3a66;
      --text:#e9eefc;
      --muted:#aab6d8;
      --btn:#2c56ff;
      --btn2:#1f3fb6;
      --danger:#ff4d4d;
      --ok:#22c55e;
      --warn:#fbbf24;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, Helvetica, sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, #1a2b60 0%, transparent 55%),
        radial-gradient(900px 600px at 80% 20%, #153d7a 0%, transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      padding:26px 14px;
    }

    .wrap{ width:min(920px, 100%); }
    .card{
      background: linear-gradient(180deg, rgba(17,28,56,.85), rgba(10,18,36,.85));
      border: 1px solid rgba(43,58,102,.75);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      border-radius: 22px;
      padding: 22px 18px;
      backdrop-filter: blur(8px);
    }

    h1{
      margin: 4px 0 8px;
      font-size: clamp(24px, 4vw, 38px);
      letter-spacing: .08em;
      text-transform: uppercase;
      text-align:center;
      font-weight: 900;
    }

    .sub{
      text-align:center;
      color: var(--muted);
      margin: 0 0 18px;
      font-size: 15px;
    }

    .pillrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-bottom: 14px;
    }

    .pill{
      border: 1px solid rgba(43,58,102,.75);
      background: rgba(8,14,28,.55);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      max-width: 100%;
    }
    .pill b{ color: var(--text); }

    label{
      display:block;
      margin: 14px 0 8px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }

    .inputBig{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(43,58,102,.9);
      background: rgba(6,10,20,.55);
      color: var(--text);
      padding: 18px 16px;
      font-size: clamp(18px, 3.8vw, 26px);
      font-family: var(--mono);
      outline:none;
      text-align:center;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .inputBig::placeholder{
      color: rgba(170,182,216,.55);
      letter-spacing: .08em;
    }

    .inputMid{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(43,58,102,.9);
      background: rgba(6,10,20,.55);
      color: var(--text);
      padding: 14px 14px;
      font-size: 18px;
      font-family: var(--mono);
      outline:none;
      text-align:left;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    select.inputMid{
      font-family: var(--sans);
      text-transform: none;
      letter-spacing: 0;
      font-weight: 700;
    }

    .btnrow{
      display:flex;
      gap:14px;
      margin-top: 14px;
      flex-wrap:wrap;
    }

    button{
      flex: 1 1 220px;
      border: none;
      border-radius: 18px;
      padding: 18px 14px;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: white;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      transition: transform .06s ease, filter .12s ease;
    }
    button:active{ transform: translateY(1px); }
    .btnPrimary{ background: linear-gradient(180deg, var(--btn), var(--btn2)); }
    .btnGhost{
      background: linear-gradient(180deg, rgba(30,41,76,.9), rgba(14,20,42,.9));
      border: 1px solid rgba(43,58,102,.9);
      box-shadow: none;
    }
    button[disabled]{
      opacity:.45;
      cursor:not-allowed;
      filter:saturate(.7);
    }

    .section{
      margin-top: 18px;
      border-radius: 18px;
      border: 1px solid rgba(43,58,102,.75);
      background: rgba(7,12,26,.35);
      padding: 14px;
    }
    .sectionTitle{
      margin:0 0 10px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }

    pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(43,58,102,.75);
      background: rgba(4,8,16,.45);
      color: #d7e3ff;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43,58,102,.55);
      background: rgba(6,10,20,.35);
    }
    .k{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .v{
      font-family: var(--mono);
      font-size: 14px;
      text-align:right;
    }

    .badge{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.04em;
      text-transform: uppercase;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .b-ok{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); color: #b7f7cd; }
    .b-warn{ background: rgba(251,191,36,.18); border-color: rgba(251,191,36,.35); color: #ffe6a6; }
    .b-bad{ background: rgba(255,77,77,.18); border-color: rgba(255,77,77,.35); color: #ffb5b5; }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 760px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .hint{
      color: rgba(170,182,216,.75);
      font-size: 12px;
      margin-top: 6px;
      line-height: 1.3;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>RASTREAMENTO DE S-B-O-O-L</h1>
      <p class="sub">Buscar, ver onde está e atualizar com responsabilidade.</p>

      <div class="pillrow">
        <div class="pill" id="sbStatus"><b>Supabase:</b> iniciando...</div>
        <div class="pill"><b>Tabela:</b> public.spools / <b>Chave:</b> nome_spool</div>
      </div>

      <label for="tagInput">TAG do S-B-O-O-L</label>
      <input
        id="tagInput"
        class="inputBig"
        placeholder="EX: IS-M01-BG-B10-0018-001-007"
        autocomplete="off"
        autocapitalize="characters"
        spellcheck="false"
      />

      <div class="btnrow">
        <button class="btnPrimary" id="btnBuscar">BUSCAR</button>
        <button class="btnGhost" id="btnLimpar">LIMPAR</button>
      </div>

      <div class="section">
        <div class="sectionTitle">Resultado atual</div>
        <div class="grid">
          <div class="kv">
            <div class="k">TAG</div>
            <div class="v" id="outTag">—</div>
          </div>
          <div class="kv">
            <div class="k">Status</div>
            <div class="v" id="outStatus">—</div>
          </div>
          <div class="kv">
            <div class="k">Localização</div>
            <div class="v" id="outLocalizacao">—</div>
          </div>
          <div class="kv">
            <div class="k">Responsável</div>
            <div class="v" id="outResponsavel">—</div>
          </div>
          <div class="kv">
            <div class="k">Atualizado em</div>
            <div class="v" id="outAtualizado">—</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">Atualizar andamento</div>

        <div class="row2">
          <div>
            <label for="inpResp">Responsável (obrigatório)</label>
            <input id="inpResp" class="inputMid" placeholder="EX: JULIO / MARCELO" autocomplete="off" />
            <div class="hint">Quem clicar para atualizar assume a responsabilidade do registro.</div>
          </div>

          <div>
            <label for="selStatus">Novo status (lista fixa)</label>
            <select id="selStatus" class="inputMid"></select>
            <div class="hint">Sem inventar status. Sem texto solto.</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label for="inpLocal">Localização (obrigatória em FOI PAGO / PISTA)</label>
          <input id="inpLocal" class="inputMid" placeholder="EX: PISTA 1 / GALPÃO / CARREIRA 2" autocomplete="off" />
          <div class="hint" id="localHint">Quando escolher “FOI PAGO – PISTA X”, a localização é preenchida automaticamente e fica obrigatória.</div>
        </div>

        <div class="btnrow">
          <button class="btnPrimary" id="btnAtualizar" disabled>ATUALIZAR</button>
          <button class="btnGhost" id="btnRecarregar" disabled>RECARREGAR</button>
        </div>

        <div class="hint">
          Dica: O certo é sempre atualizar primeiro no setor que está com o S-B-O-O-L, e só depois passar para o próximo.
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">Log / erros (aparece aqui, nada fica escondido)</div>
        <pre id="logBox">Aguardando…</pre>
      </div>
    </div>
  </div>

  <!-- 1) Carrega supabase-js (CDN 1). Se falhar, tenta CDN 2 automaticamente. -->
  <script>
    function setLog(msg) {
      const el = document.getElementById("logBox");
      if (el) el.textContent = msg;
    }
    function setSbPill(text, kind) {
      const pill = document.getElementById("sbStatus");
      if (!pill) return;
      pill.innerHTML = "<b>Supabase:</b> " + text;
      pill.classList.remove("b-ok","b-warn","b-bad");
      if (kind) pill.classList.add(kind);
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function ensureSupabaseLib() {
      setSbPill("carregando biblioteca…", "b-warn");
      try {
        await loadScript("https://unpkg.com/@supabase/supabase-js@2");
        if (!window.supabase) throw new Error("Biblioteca carregou mas window.supabase não existe.");
        return true;
      } catch (e1) {
        try {
          await loadScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2");
          if (!window.supabase) throw new Error("Biblioteca carregou mas window.supabase não existe.");
          return true;
        } catch (e2) {
          setSbPill("falhou carregar biblioteca", "b-bad");
          setLog(
            "ERRO: não consegui carregar supabase-js.\n" +
            "CDN1 (unpkg) falhou e CDN2 (jsdelivr) falhou.\n\n" +
            "Detalhe 1: " + (e1?.message || e1) + "\n" +
            "Detalhe 2: " + (e2?.message || e2)
          );
          return false;
        }
      }
    }
  </script>

  <!-- 2) App -->
  <script>
    // ✅ SUAS CREDENCIAIS (SEM TROCAR NOMES)
    const SUPABASE_URL = "https://tilpzusjfgxueieisws.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_pNIqELGC4rjHfP66OwrFHQ_bSlzcTgc";

    // ✅ Lista fixa de status (do jeito que você definiu)
    const STATUS_FIXOS = [
      "OFICINA - FABRICAÇÃO",
      "LOGÍSTICA - PÓS FABRICAÇÃO",
      "PINTURA",
      "LOGÍSTICA - PÓS PINTURA",
      "FOI PAGO - PISTA 1",
      "FOI PAGO - PISTA 2",
      "FOI PAGO - PISTA 3",
      "FOI PAGO - PISTA 4",
      "BORDO - PRODUÇÃO"
    ];

    let sb = null;
    let lastTag = null;

    function cleanTag(raw) {
      return (raw || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    function cleanUpper(raw) {
      return (raw || "").trim().toUpperCase();
    }

    function setOut(id, val) {
      const el = document.getElementById(id);
      if (el) el.textContent = (val === null || val === undefined || val === "") ? "—" : String(val);
    }

    function toLocalDateTime(isoString) {
      if (!isoString) return "—";
      try{
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString;
        return d.toLocaleString(); // horário local do iPhone/Android/PC
      } catch {
        return isoString;
      }
    }

    function clearOutputs() {
      setOut("outTag", "—");
      setOut("outStatus", "—");
      setOut("outLocalizacao", "—");
      setOut("outResponsavel", "—");
      setOut("outAtualizado", "—");
    }

    function setUpdateEnabled(on) {
      const btnAtualizar = document.getElementById("btnAtualizar");
      const btnRecarregar = document.getElementById("btnRecarregar");
      if (btnAtualizar) btnAtualizar.disabled = !on;
      if (btnRecarregar) btnRecarregar.disabled = !on;
    }

    function fillStatusSelect() {
      const sel = document.getElementById("selStatus");
      if (!sel) return;
      sel.innerHTML = "";
      for (const s of STATUS_FIXOS) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      }
    }

    function applyLocationRule() {
      const sel = document.getElementById("selStatus");
      const loc = document.getElementById("inpLocal");
      const hint = document.getElementById("localHint");
      if (!sel || !loc) return;

      const st = sel.value || "";

      // Se for FOI PAGO - PISTA X: preencher e travar
      if (st.startsWith("FOI PAGO - PISTA")) {
        const pista = st.replace("FOI PAGO - ", "").trim(); // "PISTA 1"
        loc.value = pista;
        loc.disabled = true;
        if (hint) hint.textContent = "OK: selecionou “FOI PAGO”. Localização foi preenchida automaticamente.";
        return;
      }

      // Caso contrário: liberar digitação (mas pode ficar em branco)
      loc.disabled = false;
      if (hint) hint.textContent = "Se estiver em logística/pátio, preencha a localização (pista/galpão/carreira).";
    }

    async function init() {
      fillStatusSelect();
      applyLocationRule();

      const ok = await ensureSupabaseLib();
      if (!ok) return;

      try {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        setSbPill("conectado ✅", "b-ok");
        setLog("Pronto. Cole um TAG e clique BUSCAR.");
      } catch (e) {
        setSbPill("erro no client", "b-bad");
        setLog("ERRO criando client: " + (e?.message || e));
      }
    }

    async function buscar() {
      if (!sb) { setLog("Ainda não conectou no Supabase."); return; }

      const input = document.getElementById("tagInput");
      const tag = cleanTag(input?.value);

      if (!tag) { setLog("Cole um TAG válido primeiro."); return; }

      clearOutputs();
      setUpdateEnabled(false);
      setLog("Buscando: " + tag + " …");

      try {
        const { data, error } = await sb
          .from("spools")
          .select("nome_spool,status,localizacao,responsavel,atualizado_em")
          .eq("nome_spool", tag)
          .limit(1);

        if (error) {
          setLog("Erro buscando no banco:\n" + JSON.stringify(error, null, 2));
          return;
        }

        if (!data || data.length === 0) {
          setLog("Não achei esse TAG no banco: " + tag);
          setOut("outTag", tag);
          setOut("outStatus", "NÃO ENCONTRADO");
          lastTag = null;
          return;
        }

        const row = data[0];
        lastTag = row.nome_spool;

        setOut("outTag", row.nome_spool);
        setOut("outStatus", row.status);
        setOut("outLocalizacao", row.localizacao);
        setOut("outResponsavel", row.responsavel);
        setOut("outAtualizado", toLocalDateTime(row.atualizado_em));

        // pré-seleciona o status atual no dropdown (se existir)
        const sel = document.getElementById("selStatus");
        if (sel && row.status && STATUS_FIXOS.includes(row.status)) {
          sel.value = row.status;
          applyLocationRule();
        }

        setUpdateEnabled(true);
        setLog("Encontrado ✅ Agora você pode atualizar o andamento.");
      } catch (e) {
        setLog("Falha geral:\n" + (e?.message || e));
      }
    }

    async function atualizar() {
      if (!sb) { setLog("Ainda não conectou no Supabase."); return; }
      if (!lastTag) { setLog("Busque um TAG antes de atualizar."); return; }

      const resp = cleanUpper(document.getElementById("inpResp")?.value);
      const statusNovo = document.getElementById("selStatus")?.value || "";
      const locEl = document.getElementById("inpLocal");
      const local = cleanUpper(locEl?.value);

      if (!resp) {
        setLog("ERRO: Responsável é obrigatório.");
        return;
      }

      if (!statusNovo || !STATUS_FIXOS.includes(statusNovo)) {
        setLog("ERRO: Selecione um status válido.");
        return;
      }

      // Regra: FOI PAGO - PISTA X -> localização obrigatória (e já preenchida)
      if (statusNovo.startsWith("FOI PAGO - PISTA")) {
        if (!local) {
          setLog("ERRO: Em FOI PAGO / PISTA, a localização é obrigatória.");
          return;
        }
      }

      setLog("Atualizando " + lastTag + " …");

      // atualizado_em: agora (ISO)
      const nowIso = new Date().toISOString();

      try {
        const { error } = await sb
          .from("spools")
          .update({
            status: statusNovo,
            localizacao: local || null,
            responsavel: resp,
            atualizado_em: nowIso
          })
          .eq("nome_spool", lastTag);

        if (error) {
          setLog("Erro ao atualizar:\n" + JSON.stringify(error, null, 2));
          return;
        }

        setLog("Atualizado ✅ Agora todo mundo vê.");
        // Recarrega para refletir
        await buscar();
      } catch (e) {
        setLog("Falha geral atualizando:\n" + (e?.message || e));
      }
    }

    function limpar() {
      const input = document.getElementById("tagInput");
      if (input) input.value = "";
      const resp = document.getElementById("inpResp");
      const loc = document.getElementById("inpLocal");
      if (resp) resp.value = "";
      if (loc) loc.value = "";
      lastTag = null;
      clearOutputs();
      setUpdateEnabled(false);
      applyLocationRule();
      setLog("Limpo. Cole um TAG e clique BUSCAR.");
    }

    window.addEventListener("load", () => {
      init();

      const btnBuscar = document.getElementById("btnBuscar");
      const btnLimpar = document.getElementById("btnLimpar");
      const btnAtualizar = document.getElementById("btnAtualizar");
      const btnRecarregar = document.getElementById("btnRecarregar");
      const input = document.getElementById("tagInput");
      const sel = document.getElementById("selStatus");

      if (btnBuscar) btnBuscar.addEventListener("click", buscar);
      if (btnLimpar) btnLimpar.addEventListener("click", limpar);
      if (btnAtualizar) btnAtualizar.addEventListener("click", atualizar);
      if (btnRecarregar) btnRecarregar.addEventListener("click", buscar);

      if (sel) sel.addEventListener("change", applyLocationRule);

      // Enter busca
      if (input) {
        input.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") buscar();
        });
      }
    });
  </script>
</body>
</html>
