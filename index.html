<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rastreamento de S-B-O-O-L</title>

  <!-- Ícones (iPhone usa MUITO o apple-touch-icon) -->
  <link rel="icon" href="icone.PNG" />
  <link rel="apple-touch-icon" href="icone.PNG" />

  <!-- Supabase JS (UMD estável pra browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg: #070b18;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --blue: #3b82f6;
      --blue2: #2563eb;
      --danger: #ef4444;
      --ok: #22c55e;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(59,130,246,0.18), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 22px;
    }

    .wrap{
      width: 100%;
      max-width: 860px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }

    h1{
      margin: 0 0 10px;
      letter-spacing: 1px;
      font-size: 32px;
      font-weight: 900;
      text-transform: uppercase;
      text-align: center;
    }

    .subtitle{
      text-align: center;
      color: var(--muted);
      margin-bottom: 18px;
      font-weight: 600;
    }

    .statusline{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }

    label{
      display:block;
      margin: 10px 0 8px;
      font-weight: 800;
      letter-spacing: .4px;
      color: rgba(255,255,255,0.85);
      text-transform: uppercase;
      font-size: 13px;
    }

    /* INPUT GRANDÃO */
    input{
      width: 100%;
      padding: 22px 18px;
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 1px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
      text-transform: uppercase;
    }
    input::placeholder{
      color: rgba(255,255,255,0.35);
      font-weight: 700;
    }

    .btnrow{
      display:flex;
      gap: 12px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    button{
      border: 0;
      border-radius: 18px;
      padding: 16px 18px;
      font-weight: 900;
      font-size: 22px;
      cursor: pointer;
      flex: 1;
      min-width: 160px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .btn-primary{
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color: white;
      box-shadow: 0 18px 35px rgba(37,99,235,0.28);
    }
    .btn-ghost{
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
      border: 1px solid var(--border);
    }

    .panel{
      margin-top: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      padding: 14px;
    }

    .panel h3{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.80);
    }

    pre{
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      color: rgba(255,255,255,0.90);
      background: rgba(0,0,0,0.25);
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 12px;
      min-height: 70px;
    }

    .result{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .kv{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      flex-wrap: wrap;
    }
    .k{ color: var(--muted); font-weight: 800; text-transform: uppercase; font-size: 12px; letter-spacing: .4px; }
    .v{ color: var(--text); font-weight: 900; font-size: 14px; }

    .tagok{ color: var(--ok); font-weight: 900; }
    .tagerr{ color: var(--danger); font-weight: 900; }

    .smallnote{
      margin-top: 10px;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>RASTREAMENTO DE S-B-O-O-L</h1>
      <div class="subtitle">Cole o TAG do S-B-O-O-L e pesquise. Atualiza e todo mundo vê.</div>

      <div class="statusline">
        <div class="pill" id="connPill">Supabase: <strong>iniciando...</strong></div>
        <div class="pill">Tabela: <strong>public.spools</strong> / Coluna: <strong>nome_spool</strong></div>
      </div>

      <label for="tag">TAG do S-B-O-O-L</label>
      <input id="tag" placeholder="EX: IS-M01-BG-B10-0018-001-010" autocomplete="off" />

      <div class="btnrow">
        <button class="btn-primary" onclick="buscar()">BUSCAR</button>
        <button class="btn-ghost" onclick="limpar()">LIMPAR</button>
      </div>

      <div class="panel">
        <h3>Resultado</h3>
        <div class="result" id="resultado">
          <div class="kv"><div class="k">Status</div><div class="v">Aguardando busca…</div></div>
        </div>
      </div>

      <div class="panel">
        <h3>Log / Erros (aparece aqui, nada fica escondido)</h3>
        <pre id="log"></pre>
        <div class="smallnote">
          Se aparecer “Load failed”, é quase sempre: RLS/Policy/Grants ou bloqueio de request (CORS/preflight).
          Pra testar rápido: no Supabase → Policies → tabela <b>spools</b> → <b>Disable RLS</b>.
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://tilpzusjfgxueieisws.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_pNIqELGC4rjHfP66OwrFHQ_bSlzcTgc";

    let supabase = null;

    const $ = (id) => document.getElementById(id);

    function log(msg, obj = null) {
      const stamp = new Date().toLocaleString();
      let line = `[${stamp}] ${msg}`;
      if (obj) {
        try { line += "\n" + JSON.stringify(obj, null, 2); }
        catch(e){ line += "\n" + String(obj); }
      }
      $("log").textContent = line + "\n\n" + $("log").textContent;
    }

    function setConn(ok, text) {
      $("connPill").innerHTML = `Supabase: <strong class="${ok ? "tagok" : "tagerr"}">${text}</strong>`;
    }

    function renderResultado(spool, historico = []) {
      const wrap = $("resultado");
      wrap.innerHTML = "";

      if (!spool) {
        wrap.innerHTML = `<div class="kv"><div class="k">Status</div><div class="v">Não encontrado</div></div>`;
        return;
      }

      const fields = [
        ["nome_spool", spool.nome_spool],
        ["localizacao", spool.localizacao],
        ["status", spool.status],
        ["responsavel", spool.responsavel],
        ["atualizado_em", spool.atualizado_em],
      ];

      fields.forEach(([k,v]) => {
        const safeV = (v === null || v === undefined || v === "") ? "—" : String(v);
        const div = document.createElement("div");
        div.className = "kv";
        div.innerHTML = `<div class="k">${k}</div><div class="v">${safeV}</div>`;
        wrap.appendChild(div);
      });

      if (historico && historico.length) {
        const h = document.createElement("div");
        h.className = "kv";
        h.innerHTML = `<div class="k">histórico (últimos)</div><div class="v">${historico.length} linhas</div>`;
        wrap.appendChild(h);

        const pre = document.createElement("pre");
        pre.style.marginTop = "10px";
        pre.textContent = historico
          .slice(0, 10)
          .map(x => `${x.created_at || ""} | ${x.acao || x.status || ""} | ${x.setor || x.localizacao || ""} | ${x.responsavel || ""}`)
          .join("\n");
        wrap.appendChild(pre);
      }
    }

    async function init() {
      try {
        if (!SUPABASE_URL.startsWith("http")) {
          setConn(false, "URL inválida");
          log("SUPABASE_URL inválida (precisa começar com http/https).", { SUPABASE_URL });
          return;
        }
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        setConn(true, "conectado");
        log("Supabase iniciado com sucesso.");
      } catch (e) {
        setConn(false, "erro");
        log("Erro iniciando Supabase. Confira URL/KEY.", { error: String(e) });
      }
    }

    async function buscar() {
      const tag = $("tag").value.trim().toUpperCase();
      if (!tag) {
        log("Você clicou buscar sem TAG.");
        renderResultado(null);
        return;
      }

      log("Buscando TAG no banco…", { tag });

      try {
        // 1) Busca o S-B-O-O-L
        const { data: spool, error } = await supabase
          .from("spools")
          .select("*")
          .eq("nome_spool", tag)
          .maybeSingle();

        if (error) {
          log("Erro buscando no banco (possível RLS/Policy/Grants).", error);
          renderResultado(null);
          return;
        }

        if (!spool) {
          log("TAG não encontrada.");
          renderResultado(null);
          return;
        }

        // 2) Tenta puxar histórico (se existir tabela)
        let historico = [];
        try {
          const { data: hist, error: errHist } = await supabase
            .from("historico_atualizacoes")
            .select("*")
            .eq("nome_spool", tag)
            .order("created_at", { ascending: false })
            .limit(20);

          if (!errHist && Array.isArray(hist)) historico = hist;
        } catch (_) {
          // se não existir, ignora
        }

        log("OK. Encontrado.");
        renderResultado(spool, historico);

      } catch (e) {
        // Aqui cai o famoso "TypeError: Load failed"
        log("Falha de rede/request (Load failed). Quase sempre é bloqueio de request ou RLS/Policy/Grants.", { message: String(e) });
      }
    }

    function limpar() {
      $("tag").value = "";
      $("log").textContent = "";
      $("resultado").innerHTML = `<div class="kv"><div class="k">Status</div><div class="v">Aguardando busca…</div></div>`;
      log("Tela limpa.");
    }

    init();
  </script>
</body>
</html>
