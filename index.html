<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rastreamento de SPOOL</title>

  <link rel="icon" href="icon.PNG?v=1">
  <link rel="apple-touch-icon" href="icon.PNG?v=1">

  <style>
    :root{
      --bg1:#0a1224;
      --bg2:#0e1c3a;
      --card:#0e1a33cc;
      --stroke:#2b3a66;
      --text:#e9eefc;
      --muted:#aab6d8;
      --btn:#2c56ff;
      --btn2:#1f3fb6;
      --danger:#ff4d4d;
      --ok:#22c55e;
      --warn:#fbbf24;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, #1a2b60 0%, transparent 55%),
        radial-gradient(900px 600px at 80% 20%, #153d7a 0%, transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      padding:26px 14px;
    }
    .wrap{ width:min(860px, 100%); }
    .card{
      background: linear-gradient(180deg, rgba(17,28,56,.85), rgba(10,18,36,.85));
      border: 1px solid rgba(43,58,102,.75);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      border-radius: 22px;
      padding: 22px 18px;
      backdrop-filter: blur(8px);
    }
    h1{
      margin: 6px 0 8px;
      font-size: clamp(26px, 4vw, 40px);
      letter-spacing: .08em;
      text-transform: uppercase;
      text-align:center;
      font-weight: 900;
    }
    .sub{
      text-align:center;
      color: var(--muted);
      margin: 0 0 18px;
      font-size: 15px;
      line-height:1.4;
    }
    .pillrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-bottom: 14px;
    }
    .pill{
      border: 1px solid rgba(43,58,102,.75);
      background: rgba(8,14,28,.55);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      max-width: 100%;
    }
    .pill b{ color: var(--text); }
    .badge{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.04em;
      text-transform: uppercase;
    }
    .b-ok{ background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color: #b7f7cd; }
    .b-warn{ background: rgba(251,191,36,.18); border:1px solid rgba(251,191,36,.35); color: #ffe6a6; }
    .b-bad{ background: rgba(255,77,77,.18); border:1px solid rgba(255,77,77,.35); color: #ffb5b5; }

    label{
      display:block;
      margin: 14px 0 8px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .inputBig, .input, select{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(43,58,102,.9);
      background: rgba(6,10,20,.55);
      color: var(--text);
      padding: 16px 14px;
      outline:none;
    }
    .inputBig{
      font-size: clamp(18px, 3.8vw, 26px);
      font-family: var(--mono);
      text-align:center;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .input{
      font-size: 16px;
      font-family: var(--mono);
    }
    select{
      font-size: 16px;
      font-family: var(--sans);
    }

    .btnrow{
      display:flex;
      gap:14px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    button{
      flex: 1 1 220px;
      border: none;
      border-radius: 18px;
      padding: 18px 14px;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: white;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      transition: transform .06s ease, filter .12s ease;
    }
    button:active{ transform: translateY(1px); }
    .btnSearch{ background: linear-gradient(180deg, var(--btn), var(--btn2)); }
    .btnClear{
      background: linear-gradient(180deg, rgba(30,41,76,.9), rgba(14,20,42,.9));
      border: 1px solid rgba(43,58,102,.9);
      box-shadow: none;
    }
    .btnUpdate{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(16,122,56,.95));
    }
    .btnReload{
      background: linear-gradient(180deg, rgba(148,163,184,.35), rgba(71,85,105,.35));
      border: 1px solid rgba(43,58,102,.9);
      box-shadow: none;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .section{
      margin-top: 18px;
      border-radius: 18px;
      border: 1px solid rgba(43,58,102,.75);
      background: rgba(7,12,26,.35);
      padding: 14px;
    }
    .sectionTitle{
      margin:0 0 10px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }
    pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--mono);
      font-size: 14px;
      line-height: 1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(43,58,102,.75);
      background: rgba(4,8,16,.45);
      color: #d7e3ff;
      min-height: 54px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43,58,102,.55);
      background: rgba(6,10,20,.35);
    }
    .k{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .v{
      font-family: var(--mono);
      font-size: 14px;
      text-align:right;
      max-width: 62%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .hint{
      margin-top:10px;
      text-align:center;
      color: rgba(170,182,216,.65);
      font-size: 12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>RASTREAMENTO DE SPOOL</h1>
      <p class="sub">Cole o TAG do <b>SPOOL</b>, pesquise, e (se precisar) atualize o status. Tudo fica registrado no banco.</p>

      <div class="pillrow">
        <div class="pill" id="sbStatus"><b>Supabase:</b> iniciando...</div>
        <div class="pill"><b>Tabela:</b> public.spools / <b>Coluna:</b> nome_spool</div>
      </div>

      <label for="tagInput">TAG do SPOOL</label>
      <input
        id="tagInput"
        class="inputBig"
        placeholder="EX: IS-M01-BG-B10-0018-001-010"
        autocomplete="off"
        autocapitalize="characters"
        spellcheck="false"
      />

      <div class="btnrow">
        <button class="btnSearch" id="btnBuscar">BUSCAR</button>
        <button class="btnClear" id="btnLimpar">LIMPAR</button>
      </div>

      <div class="section">
        <div class="sectionTitle">Log / Erros (aparece aqui, nada fica escondido)</div>
        <pre id="logBox">Aguardando…</pre>
      </div>

      <div class="section">
        <div class="sectionTitle">Resultado</div>
        <div class="grid">
          <div class="kv">
            <div class="k">Nome do SPOOL</div>
            <div class="v" id="outNome">—</div>
          </div>
          <div class="kv">
            <div class="k">Status</div>
            <div class="v" id="outStatus">—</div>
          </div>
          <div class="kv">
            <div class="k">Localização</div>
            <div class="v" id="outLocalizacao">—</div>
          </div>
          <div class="kv">
            <div class="k">Responsável</div>
            <div class="v" id="outResponsavel">—</div>
          </div>
          <div class="kv">
            <div class="k">Atualizado em</div>
            <div class="v" id="outAtualizado">—</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">Atualizar (produção / movimentação)</div>

        <label for="newStatus">Novo status</label>
        <select id="newStatus">
          <option value="">(não alterar)</option>
          <option value="OFICINA - FABRICAÇÃO">OFICINA - FABRICAÇÃO</option>
          <option value="LOGÍSTICA - PÓS FABRICAÇÃO">LOGÍSTICA - PÓS FABRICAÇÃO</option>
          <option value="PINTURA">PINTURA</option>
          <option value="LOGÍSTICA - PÓS PINTURA">LOGÍSTICA - PÓS PINTURA</option>
          <option value="BORDO - PRODUÇÃO">BORDO - PRODUÇÃO</option>
          <option value="BAIXADO">BAIXADO</option>
        </select>

        <label for="newLocal">Localização (opcional)</label>
        <input id="newLocal" class="input" placeholder="EX: PISTA 1 / GALPÃO / CARREIRA / LINHA 2" />

        <label for="newResp">Responsável (opcional)</label>
        <input id="newResp" class="input" placeholder="EX: VERA / JULIO / MARCELO" />

        <div class="btnrow">
          <button class="btnUpdate" id="btnAtualizar" disabled>ATUALIZAR</button>
          <button class="btnReload" id="btnRecarregar" disabled>RECARREGAR</button>
        </div>

        <div class="hint">
          A data/hora é convertida automaticamente para o horário do celular.
          <br/>Dica: sempre busque o SPOOL primeiro, depois atualize.
        </div>
      </div>
    </div>
  </div>

  <!-- 1) Carrega supabase-js -->
  <script>
    function setLog(msg) {
      const el = document.getElementById("logBox");
      if (el) el.textContent = msg;
    }
    function setSbPill(text, kind) {
      const pill = document.getElementById("sbStatus");
      if (!pill) return;
      pill.innerHTML = "<b>Supabase:</b> " + text;
      pill.classList.remove("b-ok","b-warn","b-bad");
      if (kind) pill.classList.add(kind);
    }
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    async function ensureSupabaseLib() {
      setSbPill("carregando biblioteca…", "b-warn");
      try {
        await loadScript("https://unpkg.com/@supabase/supabase-js@2");
        if (!window.supabase) throw new Error("Biblioteca carregou mas window.supabase não existe.");
        return true;
      } catch (e1) {
        try {
          await loadScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2");
          if (!window.supabase) throw new Error("Biblioteca carregou mas window.supabase não existe.");
          return true;
        } catch (e2) {
          setSbPill("falhou carregar biblioteca", "b-bad");
          setLog(
            "ERRO: não consegui carregar supabase-js.\n" +
            "CDN1 (unpkg) falhou e CDN2 (jsdelivr) falhou.\n\n" +
            "Isso normalmente é rede/DNS/VPN bloqueando.\n" +
            "Tente: desligar VPN, desligar DNS (AdGuard), trocar de rede (Wi-Fi/4G), e desativar iCloud Private Relay.\n\n" +
            "Detalhe 1: " + (e1?.message || e1) + "\n" +
            "Detalhe 2: " + (e2?.message || e2)
          );
          return false;
        }
      }
    }
  </script>

  <!-- 2) App -->
  <script>
    // ✅ SUAS CREDENCIAIS (CORRIGIDO: usar a mesma variável no createClient)
    const SUPABASE_URL = "https://tilpzusjlfgxueieisws.supabase.co";
    const SUPABASE_APIKEY = "sb_publishable_pNIqELGC4rjHfP66OwrFHQ_bSlzcTgc";

    let sb = null;
    let lastTag = null;

    function cleanTag(raw) {
      return (raw || "")
        .trim()
        .toUpperCase()
        .replace(/\s+/g, "");
    }

    function formatDateBR(iso) {
      if (!iso) return "—";
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso);
        return new Intl.DateTimeFormat("pt-BR", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit"
        }).format(d);
      } catch {
        return String(iso);
      }
    }

    function setOut(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (val === null || val === undefined || val === "") ? "—" : String(val);
    }

    function clearOutputs() {
      setOut("outNome", "—");
      setOut("outStatus", "—");
      setOut("outLocalizacao", "—");
      setOut("outResponsavel", "—");
      setOut("outAtualizado", "—");
    }

    function setButtons(enabled) {
      document.getElementById("btnAtualizar").disabled = !enabled;
      document.getElementById("btnRecarregar").disabled = !enabled;
    }

    async function pingSupabase() {
      // Ping simples pra confirmar rede + chave + tabela
      const { error } = await sb.from("spools").select("id").limit(1);
      if (error) return error;
      return null;
    }

    async function init() {
      const ok = await ensureSupabaseLib();
      if (!ok) return;

      try {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_APIKEY);
        const pingErr = await pingSupabase();
        if (pingErr) {
          setSbPill("conectou, mas sem acesso ❌", "b-bad");
          setLog(
            "Conectei, mas não consegui ler a tabela.\n\n" +
            "Mensagem: " + pingErr.message + "\n" +
            "Dica: isso pode ser RLS/Policy ou chave errada.\n"
          );
          return;
        }

        setSbPill("online ✅", "b-ok");
        setLog("Pronto. Cole um TAG de SPOOL e clique BUSCAR.");
      } catch (e) {
        setSbPill("erro no client", "b-bad");
        setLog("ERRO criando client: " + (e?.message || e));
      }
    }

    async function buscar() {
      if (!sb) {
        setLog("Ainda não conectou no Supabase. Veja o status acima.");
        return;
      }

      const input = document.getElementById("tagInput");
      const tag = cleanTag(input?.value);

      if (!tag) {
        setLog("Cole um TAG válido primeiro.");
        return;
      }

      clearOutputs();
      setButtons(false);
      setLog("Buscando: " + tag + " …");

      try {
        const { data, error } = await sb
          .from("spools")
          .select("nome_spool,status,localizacao,responsavel,atualizado_em")
          .eq("nome_spool", tag)
          .limit(1);

        if (error) {
          setLog(
            "Erro buscando no banco:\n" +
            JSON.stringify(
              {
                message: error.message,
                details: error.details || "",
                hint: error.hint || "",
                code: error.code || ""
              },
              null,
              2
            )
          );
          return;
        }

        if (!data || data.length === 0) {
          setLog("Não achei esse TAG no banco: " + tag);
          setOut("outStatus", "NÃO ENCONTRADO");
          lastTag = null;
          return;
        }

        const row = data[0];
        lastTag = tag;

        setLog("Encontrado ✅");
        setOut("outNome", row.nome_spool);
        setOut("outStatus", row.status);
        setOut("outLocalizacao", row.localizacao);
        setOut("outResponsavel", row.responsavel);
        setOut("outAtualizado", formatDateBR(row.atualizado_em));

        setButtons(true);
      } catch (e) {
        // Quando aparece "TypeError: Load failed" é quase sempre rede/DNS/VPN no iPhone
        const msg = (e?.message || String(e));
        setLog(
          "Falha geral (rede/DNS/VPN bloqueando).\n\n" +
          "Detalhe: " + msg + "\n\n" +
          "Checklist rápido no iPhone:\n" +
          "1) Desligue VPN\n" +
          "2) Se tiver DNS/AdGuard, desative\n" +
          "3) Desative iCloud Private Relay (se estiver ligado)\n" +
          "4) Troque de rede (Wi-Fi <-> 4G/5G)\n"
        );
      }
    }

    async function atualizar() {
      if (!lastTag) {
        setLog("Busque um SPOOL primeiro.");
        return;
      }

      const newStatus = document.getElementById("newStatus").value;
      const newLocal = (document.getElementById("newLocal").value || "").trim();
      const newResp  = (document.getElementById("newResp").value || "").trim();

      if (!newStatus && !newLocal && !newResp) {
        setLog("Nada para atualizar. Selecione um status ou preencha localização/responsável.");
        return;
      }

      setLog("Atualizando: " + lastTag + " …");

      const patch = {
        atualizado_em: new Date().toISOString()
      };
      if (newStatus) patch.status = newStatus;
      if (newLocal) patch.localizacao = newLocal;
      if (newResp)  patch.responsavel = newResp;

      try {
        const { data, error } = await sb
          .from("spools")
          .update(patch)
          .eq("nome_spool", lastTag)
          .select("nome_spool,status,localizacao,responsavel,atualizado_em")
          .limit(1);

        if (error) {
          setLog(
            "Erro atualizando:\n" +
            JSON.stringify(
              {
                message: error.message,
                details: error.details || "",
                hint: error.hint || "",
                code: error.code || ""
              },
              null,
              2
            )
          );
          return;
        }

        if (!data || data.length === 0) {
          setLog("Atualizei, mas não retornou linha. (Verifique Policy/RLS).");
          return;
        }

        const row = data[0];
        setLog("Atualizado ✅");
        setOut("outNome", row.nome_spool);
        setOut("outStatus", row.status);
        setOut("outLocalizacao", row.localizacao);
        setOut("outResponsavel", row.responsavel);
        setOut("outAtualizado", formatDateBR(row.atualizado_em));

      } catch (e) {
        const msg = (e?.message || String(e));
        setLog(
          "Falha geral (rede/DNS/VPN bloqueando).\n" +
          "Detalhe: " + msg
        );
      }
    }

    function limpar() {
      const input = document.getElementById("tagInput");
      if (input) input.value = "";
      document.getElementById("newStatus").value = "";
      document.getElementById("newLocal").value = "";
      document.getElementById("newResp").value = "";
      lastTag = null;
      clearOutputs();
      setButtons(false);
      setLog("Limpo. Cole um TAG de SPOOL e clique BUSCAR.");
    }

    window.addEventListener("load", () => {
      init();

      document.getElementById("btnBuscar").addEventListener("click", buscar);
      document.getElementById("btnLimpar").addEventListener("click", limpar);
      document.getElementById("btnAtualizar").addEventListener("click", atualizar);
      document.getElementById("btnRecarregar").addEventListener("click", buscar);

      document.getElementById("tagInput").addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") buscar();
      });
    });
  </script>
</body>
</html>
